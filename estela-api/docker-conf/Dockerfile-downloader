# Complete Django downloader for Kaniko build pipeline
FROM python:3.9-slim

WORKDIR /home/estela

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    build-essential \
    unixodbc-dev \
    default-libmysqlclient-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies (use deploy.txt like build-project)
COPY estela-api/requirements ./requirements
RUN pip install --no-cache-dir -r requirements/deploy.txt && \
    if [ -f requirements/externalApps.txt ]; then \
        pip install --no-cache-dir -r requirements/externalApps.txt; \
    fi

# Copy complete application code (like build-project does)
COPY estela-api/ ./estela-api
COPY database_adapters/ ./database_adapters

# Set environment for Django
ENV DJANGO_SETTINGS_MODULE=config.settings.base
ENV PYTHONPATH=/home/estela/estela-api:/home/estela

# Create non-root user
RUN useradd -m -s /bin/sh estela && chown -R estela:estela /home/estela
USER estela

ENTRYPOINT ["python3", "estela-api/build_project/download-extract.py"]